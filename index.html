<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>POS - Ferreter√≠a Sandoval</title>

<style>
body {
  font-family: Arial, sans-serif;
  background: #f2f2f2;
  margin: 0;
  padding: 10px;
}
h1 {
  text-align: center;
}
section {
  background: #fff;
  padding: 10px;
  margin-bottom: 10px;
  border-radius: 5px;
}
input, button {
  padding: 6px;
  margin: 4px 0;
  width: 100%;
}
button {
  cursor: pointer;
}
table {
  width: 100%;
  border-collapse: collapse;
  font-size: 14px;
}
th, td {
  border-bottom: 1px solid #ccc;
  padding: 4px;
}
.total {
  font-size: 18px;
  font-weight: bold;
  text-align: right;
}

/* ==== IMPRESI√ìN TICKET 80mm ==== */
@media print {
  body {
    width: 80mm;
    margin: 0;
    background: #fff;
  }
  .no-print {
    display: none;
  }
  table {
    font-size: 12px;
  }
}
</style>
</head>

<body>

<h1>FERRETER√çA SANDOVAL</h1>

<section class="no-print">
<h3>üì¶ Registrar / Editar Producto</h3>
<input id="codigo" placeholder="C√≥digo de barras">
<input id="nombre" placeholder="Nombre del producto">
<input id="categoria" placeholder="Categor√≠a">
<input id="existencia" type="number" step="0.01" placeholder="Existencia">
<input id="precio" type="number" step="0.01" placeholder="Precio normal (Q)">
<input id="precioMin" type="number" step="0.01" placeholder="Precio m√≠nimo permitido (Q)">
<button onclick="guardarProducto()">Guardar producto</button>
</section>

<section class="no-print">
<h3>üõí Punto de Venta</h3>
<input id="scan" placeholder="Escanear c√≥digo de barras" autofocus>
<table id="tablaVenta">
<thead>
<tr><th>Producto</th><th>Cant</th><th>Precio</th><th>Total</th></tr>
</thead>
<tbody></tbody>
</table>
<div class="total" id="totalVenta">Total: Q0.00</div>
<button onclick="finalizarVenta()">Finalizar venta e imprimir</button>
</section>

<section class="no-print">
<h3>üìä Cierre del D√≠a</h3>
<button onclick="cierreDelDia()">Hacer cierre y enviar WhatsApp</button>
</section>

<script>
const telefonoJefe = "50231064872";

let inventario = JSON.parse(localStorage.getItem("inventario_sandoval")) || {};
let ventasDia = JSON.parse(localStorage.getItem("ventas_dia")) || [];
let ticketNum = Number(localStorage.getItem("ticket_num")) || 1;
let carrito = [];

function guardarProducto() {
  const c = codigo.value.trim();
  if (!c) return alert("C√≥digo requerido");
  inventario[c] = {
    nombre: nombre.value,
    categoria: categoria.value,
    existencia: Number(existencia.value),
    precio: Number(precio.value),
    precioMin: Number(precioMin.value)
  };
  localStorage.setItem("inventario_sandoval", JSON.stringify(inventario));
  alert("Producto guardado");
}

scan.addEventListener("keydown", e => {
  if (e.key === "Enter") {
    agregarVenta(scan.value.trim());
    scan.value = "";
  }
});

function agregarVenta(codigo) {
  const p = inventario[codigo];
  if (!p) return alert("Producto no registrado");

  let precioCobro = prompt(
    `Precio normal: Q${p.precio}\nPrecio m√≠nimo: Q${p.precioMin}\n\nIngrese precio a cobrar:`,
    p.precio
  );
  precioCobro = Number(precioCobro);
  if (precioCobro < p.precioMin) {
    return alert("No se permite cobrar menos del precio m√≠nimo");
  }
  if (p.existencia <= 0) return alert("Sin existencia");

  p.existencia -= 1;
  carrito.push({
    nombre: p.nombre,
    cant: 1,
    precio: precioCobro,
    total: precioCobro
  });
  actualizarTabla();
  localStorage.setItem("inventario_sandoval", JSON.stringify(inventario));
}

function actualizarTabla() {
  const tb = document.querySelector("#tablaVenta tbody");
  tb.innerHTML = "";
  let total = 0;
  carrito.forEach(i => {
    total += i.total;
    tb.innerHTML += `<tr>
      <td>${i.nombre}</td>
      <td>${i.cant}</td>
      <td>Q${i.precio.toFixed(2)}</td>
      <td>Q${i.total.toFixed(2)}</td>
    </tr>`;
  });
  totalVenta.textContent = "Total: Q" + total.toFixed(2);
}

function finalizarVenta() {
  if (carrito.length === 0) return alert("No hay venta");
  const venta = {
    ticket: ticketNum,
    fecha: new Date().toLocaleString(),
    items: carrito,
    total: carrito.reduce((s,i)=>s+i.total,0)
  };
  ventasDia.push(venta);
  localStorage.setItem("ventas_dia", JSON.stringify(ventasDia));
  localStorage.setItem("ticket_num", ++ticketNum);

  imprimirTicket(venta);
  carrito = [];
  actualizarTabla();
}

function imprimirTicket(v) {
  document.body.innerHTML = `
  <h3 style="text-align:center">FERRETER√çA SANDOVAL</h3>
  Ticket #${v.ticket}<br>
  ${v.fecha}<br><hr>
  ${v.items.map(i=>`${i.nombre}<br>${i.cant} x Q${i.precio} = Q${i.total}`).join("<br>")}
  <hr>
  TOTAL: Q${v.total.toFixed(2)}<br><br>
  Gracias por su compra
  `;
  window.print();
  location.reload();
}

function cierreDelDia() {
  if (ventasDia.length === 0) return alert("No hay ventas");
  let texto = `üìä CIERRE DIARIO ‚Äì FERRETER√çA SANDOVAL\n`;
  texto += `Fecha: ${new Date().toLocaleDateString()}\n\n`;
  let total = 0;
  ventasDia.forEach(v => total += v.total);
  texto += `Tickets: ${ventasDia.length}\n`;
  texto += `TOTAL VENDIDO: Q${total.toFixed(2)}\n\n`;
  texto += `Detalle:\n`;
  ventasDia.forEach(v => {
    v.items.forEach(i=>{
      texto += `- ${i.nombre}: Q${i.total}\n`;
    });
  });

  window.open(
    `https://wa.me/${telefonoJefe}?text=${encodeURIComponent(texto)}`,
    "_blank"
  );

  ventasDia = [];
  localStorage.setItem("ventas_dia", JSON.stringify([]));
  alert("Cierre realizado, ventas reiniciadas");
}
</script>

</body>
</html>